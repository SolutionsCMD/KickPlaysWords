<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Chat Guessing Game</title>
  <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#0a0a1a 0%,#101028 50%,#0a0a1a 100%);color:#e0e0e0;min-height:100vh;padding:20px}
    .container{max-width:1600px;margin:0 auto}
    .header{text-align:center;margin-bottom:25px;padding:20px;background:rgba(255,255,255,0.05);border-radius:15px}
    .header h1{font-size:2.2em;color:#00ff88;margin-bottom:8px}
    .header .subtitle{color:#999;font-size:1em}
    .header-actions{margin-top:10px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .main-grid{display:grid;grid-template-columns:380px 1fr;gap:20px;margin-bottom:20px}
    .panel{background:rgba(255,255,255,0.05);border-radius:15px;padding:22px;border:1px solid rgba(255,255,255,0.1)}
    .panel h2{color:#00ff88;margin-bottom:18px;font-size:1.4em;display:flex;align-items:center;gap:10px}
    .status-dot{width:12px;height:12px;border-radius:50%;background:#ff4444;display:inline-block}
    .status-dot.active{background:#00ff88;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;margin-bottom:6px;color:#aaa;font-size:0.85em;text-transform:uppercase;letter-spacing:1px}
    input[type="text"],input[type="number"],select{width:100%;padding:10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;font-size:0.95em}
    input:focus,select:focus{outline:none;border-color:#00ff88;box-shadow:0 0 12px rgba(0,255,136,0.3)}
    select{-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300ff88' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:36px;cursor:pointer}
    select option{background:#1a1a2e;color:#e0e0e0}
    .checkbox-group{display:flex;align-items:center;gap:10px;margin-bottom:10px;cursor:pointer}
    .checkbox-group input[type="checkbox"]{-webkit-appearance:none;appearance:none;width:20px;height:20px;min-width:20px;background:rgba(255,255,255,0.08);border:2px solid rgba(255,255,255,0.25);border-radius:5px;cursor:pointer;position:relative}
    .checkbox-group input[type="checkbox"]:checked{background:#00ff88;border-color:#00ff88}
    .checkbox-group input[type="checkbox"]:checked::after{content:'';position:absolute;top:3px;left:6px;width:5px;height:9px;border:solid #000;border-width:0 2px 2px 0;transform:rotate(45deg)}
    .checkbox-group label{margin:0!important;text-transform:none!important;cursor:pointer;color:#ccc;font-size:0.9em}
    .button{padding:10px 20px;border:none;border-radius:8px;font-size:0.95em;font-weight:bold;cursor:pointer;text-transform:uppercase;letter-spacing:1px;transition:all 0.3s}
    .button:hover{transform:translateY(-1px);box-shadow:0 4px 15px rgba(0,0,0,0.3)}
    .button-primary{background:linear-gradient(135deg,#00ff88,#00cc6a);color:#000}
    .button-secondary{background:linear-gradient(135deg,#4a9eff,#2d7de0);color:#fff}
    .button-danger{background:linear-gradient(135deg,#ff4444,#cc0000);color:#fff}
    .button-warning{background:linear-gradient(135deg,#ffa500,#ff8c00);color:#000}
    .button-sm{padding:6px 14px;font-size:0.8em}
    .button-group{display:flex;gap:8px;flex-wrap:wrap}
    .button-full{width:100%}
    .mode-tabs{display:flex;gap:8px;margin-bottom:16px}
    .mode-tab{flex:1;padding:10px;background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.2);border-radius:8px;cursor:pointer;text-align:center;color:#ccc;font-size:0.9em}
    .mode-tab:hover{border-color:rgba(0,255,136,0.5)}
    .mode-tab.active{background:rgba(0,255,136,0.2);border-color:#00ff88;color:#fff}
    .settings-section{background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;margin-bottom:12px}
    .settings-section h3{color:#00ff88;font-size:0.95em;margin-bottom:8px}
    .channel-box{background:rgba(74,158,255,0.1);border:2px solid rgba(74,158,255,0.3);border-radius:10px;padding:12px;margin-bottom:16px}
    .channel-box h3{color:#4a9eff;font-size:0.95em;margin-bottom:8px}
    .channel-box .input-row{display:flex;gap:8px}
    .channel-box .input-row input{flex:1}
    .channel-status{margin-top:6px;font-size:0.8em;color:#999}
    .channel-status.connected{color:#00ff88}
    .channel-status.error{color:#ff4444}
    .game-display{min-height:400px}
    .word-display{text-align:center;margin-bottom:25px;padding:20px;background:rgba(0,255,136,0.08);border-radius:12px;border:2px solid rgba(0,255,136,0.2)}
    .word-display .letters{display:flex;justify-content:center;gap:8px;margin-top:12px;flex-wrap:wrap}
    .word-display .letter-box{width:55px;height:55px;background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.3);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.8em;font-weight:bold;transition:all 0.4s}
    .word-display .letter-box.correct{background:linear-gradient(135deg,#00ff88,#00cc6a);color:#000;border-color:#00ff88}
    .word-display .letter-box.present{background:linear-gradient(135deg,#ffa500,#ff8c00);color:#000;border-color:#ffa500}
    .word-display .letter-box.absent{background:rgba(68,68,68,0.8);color:#888;border-color:#555}
    .word-display .actual-word{color:#ffd700;font-size:1.2em;margin-top:10px;font-weight:bold}
    .game-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:25px}
    .stat-card{background:rgba(255,255,255,0.05);padding:15px;border-radius:10px;text-align:center}
    .stat-card .value{font-size:2em;color:#00ff88;font-weight:bold;margin-bottom:3px}
    .stat-card .label{color:#999;font-size:0.8em;text-transform:uppercase}
    .guesses-feed{max-height:500px;overflow-y:auto;padding-right:8px}
    .guesses-feed::-webkit-scrollbar{width:8px}
    .guesses-feed::-webkit-scrollbar-track{background:rgba(255,255,255,0.05);border-radius:4px}
    .guesses-feed::-webkit-scrollbar-thumb{background:rgba(0,255,136,0.3);border-radius:4px}
    .guess-item{background:rgba(255,255,255,0.05);padding:12px;border-radius:8px;margin-bottom:10px;border-left:4px solid rgba(255,255,255,0.2);animation:slideIn 0.3s ease-out}
    @keyframes slideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
    .guess-item.winner{background:rgba(0,255,136,0.15);border-left-color:#00ff88}
    .guess-item .username{font-weight:bold;color:#00ff88;margin-bottom:5px;font-size:0.95em}
    .guess-item.winner .username::after{content:" - WINNER!";color:#ffd700}
    .guess-item.wrong-length{opacity:0.5;border-left-color:rgba(255,255,255,0.1)}
    .guess-item .guess-word{font-size:1.1em;margin-bottom:8px;display:flex;gap:4px;flex-wrap:wrap}
    .guess-item .letter{width:30px;height:30px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.1);border-radius:4px;font-weight:bold;font-size:0.9em;text-transform:uppercase}
    .guess-item .letter.correct{background:#00ff88;color:#000}
    .guess-item .letter.present{background:#ffa500;color:#000}
    .guess-item .letter.absent{background:#444;color:#999}
    .guess-item .timestamp{color:#666;font-size:0.75em}
    .winner-banner{background:linear-gradient(135deg,rgba(255,215,0,0.25),rgba(0,255,136,0.15));border:2px solid #ffd700;color:#ffd700;padding:20px;border-radius:15px;text-align:center;margin-bottom:20px;font-size:1.3em;font-weight:bold}
    .stopped-banner{background:rgba(255,68,68,0.15);border:2px solid rgba(255,68,68,0.4);border-radius:12px;padding:20px;text-align:center;margin-bottom:20px;color:#ff6666;font-size:1.3em;font-weight:bold}
    .no-game{text-align:center;padding:50px 20px;color:#666}
    .hints-panel{background:rgba(255,165,0,0.08);border:2px solid rgba(255,165,0,0.25);border-radius:10px;padding:15px;margin-bottom:16px}
    .hints-panel h3{color:#ffa500;font-size:0.95em;margin-bottom:10px}
    .hint-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:8px;background:rgba(0,0,0,0.3);border-radius:6px;border-left:3px solid rgba(255,165,0,0.5)}
    .hint-row.revealed{border-left-color:#00ff88;background:rgba(0,255,136,0.08)}
    .hint-row .hint-num{color:#ffa500;font-weight:bold;min-width:20px;font-size:0.85em}
    .hint-row .hint-time{color:#888;font-size:0.75em;min-width:45px}
    .hint-row .hint-text{flex:1;color:#ddd;font-size:0.85em}
    .hint-row .hint-text input{width:100%;padding:4px 8px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);border-radius:4px;color:#fff;font-size:0.9em}
    .hint-btn{padding:4px 10px;border:none;border-radius:4px;font-size:0.75em;cursor:pointer;font-weight:bold}
    .hint-btn-edit{background:rgba(74,158,255,0.3);color:#4a9eff}
    .hint-btn-reveal{background:rgba(0,255,136,0.3);color:#00ff88}
    .hint-btn-save{background:rgba(255,165,0,0.3);color:#ffa500}
    .winner-history{background:rgba(255,215,0,0.05);border:2px solid rgba(255,215,0,0.2);border-radius:10px;padding:15px;margin-top:16px;margin-bottom:16px}
    .winner-history h3{color:#ffd700;font-size:0.95em;margin-bottom:10px}
    .wh-list{max-height:250px;overflow-y:auto}
    .wh-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:rgba(0,0,0,0.2);border-radius:6px;margin-bottom:6px;font-size:0.85em}
    .wh-item .wh-user{color:#00ff88;font-weight:bold}
    .wh-item .wh-word{color:#ffd700;font-family:monospace;text-transform:uppercase;letter-spacing:1px}
    .wh-item .wh-info{color:#888;font-size:0.8em}
    .danger-zone{background:rgba(255,68,68,0.06);border:2px solid rgba(255,68,68,0.2);border-radius:10px;padding:12px;margin-top:16px}
    .danger-zone h3{color:#ff4444;font-size:0.9em;margin-bottom:8px}
    .marbles-section{background:rgba(74,158,255,0.06);border:2px solid rgba(74,158,255,0.2);border-radius:10px;padding:15px;margin-top:16px}
    .marbles-section h3{color:#4a9eff;font-size:0.95em;margin-bottom:10px}
    .marbles-info{background:rgba(0,0,0,0.3);padding:10px 12px;border-radius:6px;font-size:0.8em;color:#aaa;line-height:1.5}
    .expanded-section{background:rgba(255,165,0,0.06);border:2px solid rgba(255,165,0,0.2);border-radius:10px;padding:15px;margin-bottom:12px}
    .expanded-section h3{color:#ffaa00;font-size:0.95em;margin-bottom:10px}
    .expanded-warning{margin-top:8px;background:rgba(0,0,0,0.3);padding:10px 12px;border-radius:6px;font-size:0.8em;color:#cca050;line-height:1.5}
    .connection-status{position:fixed;top:15px;right:15px;padding:8px 16px;border-radius:8px;color:#fff;font-size:0.85em;z-index:1000}
    .connection-status.connected{background:rgba(0,255,136,0.9);color:#000}
    .connection-status.disconnected{background:rgba(255,68,68,0.9)}
    .connection-status.unauthorized{background:rgba(255,165,0,0.9);color:#000}
    .credit{position:fixed;bottom:10px;right:15px;color:rgba(255,255,255,0.25);font-size:0.8em;letter-spacing:1px;pointer-events:none;z-index:999}
    .mod-access-section{background:rgba(138,43,226,0.06);border:2px solid rgba(138,43,226,0.3);border-radius:10px;padding:15px;margin-top:16px}
    .mod-access-section h3{color:#b06aff;font-size:0.95em;margin-bottom:10px}
    .mod-preset-tabs{display:flex;gap:6px;margin-bottom:12px}
    .mod-preset-tab{flex:1;padding:8px 6px;background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.15);border-radius:6px;cursor:pointer;text-align:center;color:#ccc;font-size:0.8em}
    .mod-preset-tab:hover{border-color:rgba(138,43,226,0.5)}
    .mod-preset-tab.active{background:rgba(138,43,226,0.2);border-color:#b06aff;color:#fff}
    .mod-perm-list{margin-bottom:12px}
    .mod-perm-list .checkbox-group{margin-bottom:6px}
    .mod-perm-list .checkbox-group label{font-size:0.85em}
    .mod-link-item{background:rgba(0,0,0,0.2);padding:10px 12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .mod-link-item .mod-link-info{flex:1;min-width:120px}
    .mod-link-item .mod-link-label{color:#b06aff;font-weight:bold;font-size:0.9em}
    .mod-link-item .mod-link-expiry{color:#888;font-size:0.75em;margin-top:2px}
    .mod-link-item .mod-link-perms{color:#aaa;font-size:0.7em;margin-top:2px}
    .mod-warning{background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.3);border-radius:6px;padding:10px;margin-bottom:12px;font-size:0.8em;color:#cca050;line-height:1.5}
    .mod-banner{background:rgba(138,43,226,0.15);border:2px solid rgba(138,43,226,0.4);border-radius:10px;padding:12px 16px;margin-bottom:16px;text-align:center}
    .mod-banner .mod-badge{color:#b06aff;font-weight:bold;font-size:1.1em}
    .mod-banner .mod-expiry{color:#999;font-size:0.85em;margin-top:4px}
    .perm-denied{opacity:0.3;pointer-events:none;user-select:none}
    .collapsible{margin-bottom:12px}
    .collapsible-header{display:flex;align-items:center;gap:8px;padding:10px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);border-radius:8px;cursor:pointer;user-select:none;transition:all 0.2s}
    .collapsible-header:hover{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.2)}
    .collapsible-header.open{border-radius:8px 8px 0 0;border-bottom-color:transparent}
    .collapsible-header .arrow{color:#00ff88;font-size:0.8em;transition:transform 0.2s}
    .collapsible-header.open .arrow{transform:rotate(90deg)}
    .collapsible-header .col-title{color:#ccc;font-size:0.9em;font-weight:600}
    .collapsible-body{display:none;padding:12px;border:1px solid rgba(255,255,255,0.12);border-top:none;border-radius:0 0 8px 8px;background:rgba(255,255,255,0.02)}
    .collapsible-body.open{display:block}
    @media(max-width:1200px){.main-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="connection-status disconnected" id="connectionStatus">Connecting...</div>
  <div class="container" id="mainContent" style="display:none">
    <div class="header">
      <h1>Chat Guessing Game - Admin</h1>
      <p class="subtitle">Room: <strong id="roomIdDisplay">--</strong></p>
      <div class="header-actions">
        <button class="button button-secondary button-sm" onclick="openViewer()">Open Viewer Page</button>
        <button class="button button-primary button-sm" onclick="copyViewerLink()">Copy Viewer Link</button>
      </div>
    </div>
    <div id="modBanner" class="mod-banner" style="display:none">
      <div class="mod-badge">ðŸ”‘ Mod Access</div>
      <div class="mod-expiry" id="modExpiryText">Expires in --</div>
    </div>
    <div class="main-grid">
      <div class="panel">
        <h2><span class="status-dot" id="statusDot"></span> Game Controls</h2>
        <div class="button-group" style="margin-bottom:18px" id="startBtnWrap"><button class="button button-primary button-full" style="padding:14px 20px;font-size:1.1em" onclick="startGame()">Start Game</button></div>
        <div class="button-group" style="margin-bottom:18px" id="stopRevealWrap"><button class="button button-danger" style="flex:1;padding:12px" onclick="stopGame()">Stop</button><button class="button button-warning" style="flex:1;padding:12px" onclick="revealWord()">Reveal Word</button></div>
        <div class="channel-box" id="channelWrap"><h3>Chat Channel</h3><div class="input-row"><input type="text" id="channelInput" placeholder="mizkif, kick.com/mizkif, or chatroom ID"><button class="button button-secondary button-sm" onclick="connectChannel()">Connect</button></div><div class="channel-status" id="channelStatus">Not connected</div></div>
        <div class="mode-tabs" id="modeTabsWrap"><div class="mode-tab" data-mode="wordle"><strong>Wordle</strong></div><div class="mode-tab active" data-mode="noHints"><strong>Hard Mode</strong></div><div class="mode-tab" data-mode="fun" style="border-color:rgba(255,165,0,0.4)"><strong>Fun Mode</strong></div></div>
        <div id="aiWarning" style="display:none;background:rgba(255,68,68,0.1);border:1px solid rgba(255,68,68,0.3);border-radius:6px;padding:10px;margin-bottom:12px;font-size:0.85em;color:#ff8888">WARNING: Wordle-style modes can be easily cheated with AI tools (ChatGPT, etc). Do not use for giveaways.</div>
        <div id="funModeInfo" style="display:none;background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.3);border-radius:6px;padding:10px;margin-bottom:12px;font-size:0.85em;color:#cca050">Fun Mode: 60-second rounds with Wordle-style feedback and x100 word pool. Auto-restarts after each round. Words can be any length.</div>
        <div id="wordSettingsWrap">
        <div class="form-group"><label>Target Word</label><input type="text" id="wordInput" placeholder="Leave empty to auto-roll, or type a custom word"></div>
        <div style="display:flex;gap:8px;align-items:flex-end;margin-bottom:16px" id="wordLengthRow"><div class="form-group" style="margin-bottom:0;flex:1"><label>Word Length</label><select id="wordLength"><option value="4">4 Letters</option><option value="5" selected>5 Letters</option><option value="6">6 Letters</option><option value="7">7 Letters</option></select></div><button class="button button-secondary button-sm" onclick="generateRandomWord()" style="height:38px">Random Word</button></div>
        </div>

        <div id="winnerHistoryWrap"><div class="winner-history" id="winnerHistory" style="display:none"><h3>Winner History</h3><div class="wh-list" id="winnerHistoryList"></div></div></div>

        <div id="settingsWrap">

        <div class="collapsible" id="prizeCollapsible">
          <div class="collapsible-header" onclick="toggleCollapsible('prizeCollapsible')"><span class="arrow">â–¸</span><span class="col-title">Prize Display</span></div>
          <div class="collapsible-body">
            <div class="checkbox-group"><input type="checkbox" id="prizeToggle" onchange="togglePrize()"><label for="prizeToggle">Show prize amount on viewer page</label></div>
            <div id="prizeInputGroup" style="display:none"><div class="form-group" style="margin-bottom:0"><label>Prize Amount (e.g. $50, 500 bits, 1 month sub)</label><input type="text" id="prizeInput" placeholder="$50" onchange="updatePrize()"></div></div>
          </div>
        </div>

        <div class="collapsible" id="autoRestartCollapsible">
          <div class="collapsible-header" onclick="toggleCollapsible('autoRestartCollapsible')"><span class="arrow">â–¸</span><span class="col-title">Auto-Restart</span></div>
          <div class="collapsible-body">
            <div class="checkbox-group"><input type="checkbox" id="autoRestartToggle" onchange="toggleAutoRestart()"><label for="autoRestartToggle">Auto-start new game after a win</label></div>
            <div class="form-group" style="margin-top:8px"><label>Countdown (seconds)</label><input type="number" id="autoRestartSecondsInput" value="60" min="10" max="300" onchange="updateAutoRestartSeconds()"></div>
            <div class="checkbox-group" style="margin-top:8px"><input type="checkbox" id="shuffleLengthToggle" onchange="toggleShuffleLength()"><label for="shuffleLengthToggle">Shuffle word length (random 4-7 letters each round)</label></div>
          </div>
        </div>

        <div class="collapsible" id="wordPoolCollapsible">
          <div class="collapsible-header" onclick="toggleCollapsible('wordPoolCollapsible')"><span class="arrow">â–¸</span><span class="col-title">Word Pool & Display</span></div>
          <div class="collapsible-body">
            <div class="checkbox-group"><input type="checkbox" id="expandedPoolToggle" onchange="toggleExpandedPool()"><label for="expandedPoolToggle">x100 Word Pool (use full accepted guesses list)</label></div>
            <div class="expanded-warning" id="expandedPoolWarning" style="display:none"><strong>WARNING:</strong> x100 mode pulls from <span id="expandedPoolCount">0</span> words. Words can be any length and some may be very obscure.</div>
            <div class="checkbox-group" style="margin-top:10px"><input type="checkbox" id="hideLetterCountToggle" onchange="toggleHideLetterCount()"><label for="hideLetterCountToggle">Hide letter count from viewers</label></div>
          </div>
        </div>

        </div>

        <div id="wordleSettingsWrap">
        <div class="collapsible" id="wordleSettingsCollapsible" style="display:none">
          <div class="collapsible-header" onclick="toggleCollapsible('wordleSettingsCollapsible')"><span class="arrow">â–¸</span><span class="col-title">Wordle Settings</span></div>
          <div class="collapsible-body" id="wordleSettings">
            <div class="checkbox-group"><input type="checkbox" id="cooldownEnabled"><label for="cooldownEnabled">Enable Cooldown</label></div>
            <div class="form-group"><label>Cooldown (seconds)</label><input type="number" id="cooldownSeconds" value="5" min="1" max="60"></div>
            <div class="form-group"><label>Max Guesses Per User (0 = unlimited)</label><input type="number" id="maxGuesses" value="0" min="0" max="20"></div>
            <div class="checkbox-group"><input type="checkbox" id="timerEnabled"><label for="timerEnabled">Enable Round Timer</label></div>
            <div class="form-group"><label>Timer (minutes)</label><input type="number" id="timerMinutes" value="10" min="1" max="60"></div>
          </div>
        </div>
        <div id="hintsPreviewWrap">
        <div class="collapsible" id="hintsCollapsible">
          <div class="collapsible-header" onclick="toggleCollapsible('hintsCollapsible')"><span class="arrow">â–¸</span><span class="col-title">Hints</span></div>
          <div class="collapsible-body">
            <div class="checkbox-group" style="margin-bottom:10px"><input type="checkbox" id="hintsEnabled" checked><label for="hintsEnabled">Enable Progressive Hints</label></div>
            <div id="hintsPreview"></div>
          </div>
        </div>
        </div>
        </div>

        <div id="modAccessSection" style="display:none">
          <div class="collapsible" id="modAccessCollapsible">
            <div class="collapsible-header" onclick="toggleCollapsible('modAccessCollapsible')"><span class="arrow">â–¸</span><span class="col-title">ðŸ”‘ Mod Access</span></div>
            <div class="collapsible-body">
              <div class="mod-warning">âš  Only share mod links in <strong>private DMs</strong>. Anyone with the link gets admin access to your game. Links expire after <strong>3 hours</strong>.</div>
              <div style="margin-bottom:12px">
                <label style="display:block;margin-bottom:6px;color:#aaa;font-size:0.8em;text-transform:uppercase;letter-spacing:1px">Preset</label>
                <div class="mod-preset-tabs" id="modPresetTabs">
                  <div class="mod-preset-tab active" data-preset="operator">Game Operator</div>
                  <div class="mod-preset-tab" data-preset="fullmod">Full Mod</div>
                  <div class="mod-preset-tab" data-preset="custom">Custom</div>
                </div>
              </div>
              <div class="mod-perm-list" id="modPermList">
                <div class="checkbox-group"><input type="checkbox" id="modPerm_gameControls" checked><label for="modPerm_gameControls">Start / Stop / Reveal games</label></div>
                <div class="checkbox-group"><input type="checkbox" id="modPerm_connectChat"><label for="modPerm_connectChat">Connect chat channel</label></div>
                <div class="checkbox-group"><input type="checkbox" id="modPerm_changeMode"><label for="modPerm_changeMode">Change game mode</label></div>
                <div class="checkbox-group"><input type="checkbox" id="modPerm_setWord"><label for="modPerm_setWord">See & set the target word</label></div>
                <div class="checkbox-group"><input type="checkbox" id="modPerm_changeSettings"><label for="modPerm_changeSettings">Change settings (timer, hints, pool, prize)</label></div>
                <div class="checkbox-group"><input type="checkbox" id="modPerm_editHints"><label for="modPerm_editHints">Edit & reveal hints</label></div>
                <div class="checkbox-group"><input type="checkbox" id="modPerm_dangerZone"><label for="modPerm_dangerZone">Danger Zone (reset leaderboard)</label></div>
              </div>
              <button class="button button-secondary button-sm" onclick="createModLink()" style="width:100%;margin-bottom:12px">Generate Mod Link</button>
              <div id="modLinksList"></div>
            </div>
          </div>
        </div>

        <div id="dangerZoneWrap">
        <div class="danger-zone"><h3>Danger Zone</h3><button class="button button-danger button-sm" onclick="resetLeaderboard()" style="margin-top:6px">Reset Leaderboard</button><p style="color:#888;font-size:0.75em;margin-top:6px">Leaderboard is saved to your server and persists across refreshes and restarts.</p><button class="button button-danger button-sm" onclick="regenerateToken()" style="margin-top:10px">Regenerate Admin Token</button><p style="color:#888;font-size:0.75em;margin-top:6px">Creates a new admin token. You will be reconnected automatically.</p></div>
        </div>
        <div class="marbles-section"><h3>Marbles Integration</h3><div class="marbles-info">For Marbles: run Custom Game with Bots, set bot count to match player count, then import the CSV. Title shows the number of entries. Boosts don't work.</div><div style="display:flex;gap:8px;align-items:center;margin-top:10px"><button class="button button-secondary button-sm" onclick="downloadParticipants()">Download CSV</button><button class="button button-danger button-sm" onclick="clearParticipants()">Clear List</button><span id="participantCount" style="color:#999;font-size:0.85em"></span></div></div>
      </div>
      <div class="panel game-display"><h2>Game Display</h2><div id="gameContent"><div class="no-game"><h3>No Active Game</h3><p>Start a game to begin</p></div></div></div>
    </div>
  </div>
  <div id="noAccess" style="display:none;text-align:center;padding:100px 20px">
    <h2 style="color:#ff6666;margin-bottom:15px">Access Denied</h2>
    <p style="color:#999;font-size:1.2em">Invalid or missing admin token. Open Admin from the viewer page to get access.</p>
  </div>
  <div class="credit">Created by OsrsSolutions</div>
  <script>
    var params = new URLSearchParams(window.location.search);
    var adminToken = params.get('token');
    var roomId = null;
    var ws = null, currentMode = 'noHints', gameState = null, editingHints = {};
    var wordManuallyEdited = false;
    var isModSession = false, modPerms = null, modExpires = null;

    // SESSION: save token to localStorage so refreshing works
    if (adminToken) {
      localStorage.setItem('chatgame_admin_token', adminToken);
      // Clean token from URL
      history.replaceState(null, '', '/admin');
    } else {
      adminToken = localStorage.getItem('chatgame_admin_token');
    }

    if (!adminToken) {
      document.getElementById('noAccess').style.display = 'block';
      document.getElementById('connectionStatus').textContent = 'No Token';
      document.getElementById('connectionStatus').className = 'connection-status unauthorized';
    } else {
      document.getElementById('mainContent').style.display = 'block';
      connectWebSocket();
    }

    document.getElementById('wordInput').addEventListener('input', function() { wordManuallyEdited = true; });

    function adminFetch(url, options) {
      options = options || {};
      if (options.method === 'POST' || options.method === 'post') {
        var body = options.body ? JSON.parse(options.body) : {};
        body.token = adminToken;
        options.body = JSON.stringify(body);
        if (!options.headers) options.headers = {};
        options.headers['Content-Type'] = 'application/json';
      } else {
        var sep = url.includes('?') ? '&' : '?';
        url += sep + 'token=' + adminToken;
      }
      return fetch(url, options);
    }

    var pusherConnection = null;
    var pusherChannel = null;
    var currentChatroomId = null;

    function disconnectPusher() {
      if (pusherChannel) { try { pusherChannel.unbind_all(); } catch(e){} pusherChannel = null; }
      if (pusherConnection) { try { pusherConnection.disconnect(); } catch(e){} pusherConnection = null; }
      if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ type: 'chatRelayStatus', connected: false }));
    }

    function connectPusher(chatroomId) {
      disconnectPusher();
      currentChatroomId = chatroomId;
      var st = document.getElementById('channelStatus');
      try {
        pusherConnection = new Pusher('32cbd69e4b950bf97679', { cluster: 'us2', forceTLS: true });
        pusherConnection.connection.bind('connected', function() {
          st.textContent = 'Connected to ' + (gameState && gameState.channelName || 'channel');
          st.className = 'channel-status connected';
          if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ type: 'chatRelayStatus', connected: true }));
        });
        pusherConnection.connection.bind('disconnected', function() {
          st.textContent = 'Chat disconnected - reconnecting...';
          st.className = 'channel-status';
          if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ type: 'chatRelayStatus', connected: false }));
        });
        pusherConnection.connection.bind('error', function(err) {
          console.error('Pusher error:', err);
          st.textContent = 'Chat connection error';
          st.className = 'channel-status error';
        });
        pusherChannel = pusherConnection.subscribe('chatrooms.' + chatroomId + '.v2');
        pusherChannel.bind('App\\Events\\ChatMessageEvent', function(data) { relayChatMessage(data); });
        pusherChannel.bind('App\\Events\\ChatMessageSentEvent', function(data) { relayChatMessage(data); });
      } catch(e) {
        st.textContent = 'Failed to connect: ' + e.message;
        st.className = 'channel-status error';
      }
    }

    function relayChatMessage(data) {
      var username = (data.sender && (data.sender.username || data.sender.slug)) || (data.user && data.user.username) || 'Anonymous';
      var message = data.content || (data.message && (data.message.content || data.message)) || '';
      if (!username || !message || username === 'Anonymous') return;
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'chatMessage', username: username, message: message.trim() }));
      }
    }

    async function connectChannel() {
      var raw = document.getElementById('channelInput').value.trim();
      if (!raw) return;
      var st = document.getElementById('channelStatus');
      var username = raw.replace(/^(https?:\/\/)?(www\.)?kick\.com\/?/i, '').replace(/\/$/, '').trim().toLowerCase();
      if (!username) { st.textContent = 'Enter a valid username'; st.className = 'channel-status error'; return; }
      st.textContent = 'Looking up ' + username + '...'; st.className = 'channel-status';
      try {
        var kickRes = await fetch('https://kick.com/api/v2/channels/' + username);
        if (!kickRes.ok) throw new Error('Channel not found');
        var kickData = await kickRes.json();
        var chatroomId = kickData.chatroom && kickData.chatroom.id;
        var displayName = (kickData.user && kickData.user.username) || kickData.slug || username;
        if (!chatroomId) throw new Error('No chatroom found');
        // Tell server about the channel
        var res = await adminFetch('/api/channel/connect', { method: 'POST', body: JSON.stringify({ chatroomId: chatroomId, channelName: displayName }) });
        var data = await res.json();
        if (data.success) {
          st.textContent = 'Connecting to ' + data.channelName + '...';
          // Connect browser-side Pusher
          connectPusher(chatroomId);
        } else { st.textContent = 'Error: ' + (data.error || 'Failed'); st.className = 'channel-status error'; }
      } catch (e) {
        if (/^\d+$/.test(username)) {
          try {
            var res2 = await adminFetch('/api/channel/connect', { method: 'POST', body: JSON.stringify({ chatroomId: parseInt(username), channelName: 'Channel ' + username }) });
            var data2 = await res2.json();
            if (data2.success) { connectPusher(parseInt(username)); return; }
          } catch (e2) {}
        }
        st.textContent = 'Error: ' + e.message; st.className = 'channel-status error';
      }
    }
    document.getElementById('channelInput').addEventListener('keydown', function(e) { if (e.key === 'Enter') connectChannel(); });

    function connectWebSocket() {
      var p = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(p + '//' + window.location.host + '/?token=' + adminToken);
      ws.onopen = function() { document.getElementById('connectionStatus').textContent = 'Connected'; document.getElementById('connectionStatus').className = 'connection-status connected'; if (pusherConnection && pusherConnection.connection.state === 'connected') { ws.send(JSON.stringify({ type: 'chatRelayStatus', connected: true })); } };
      ws.onclose = function(e) {
        var c = document.getElementById('connectionStatus');
        if (e.code === 4001) { c.textContent = 'Invalid Token'; c.className = 'connection-status unauthorized'; document.getElementById('mainContent').style.display = 'none'; document.getElementById('noAccess').style.display = 'block'; localStorage.removeItem('chatgame_admin_token'); return; }
        c.textContent = 'Disconnected'; c.className = 'connection-status disconnected'; setTimeout(connectWebSocket, 3000);
      };
      ws.onmessage = function(event) {
        var data = JSON.parse(event.data);
        switch (data.type) {
          case 'modPermissions': isModSession = true; modPerms = data.permissions; applyModPermissions(); break;
          case 'gameUpdate': gameState = data.game; if (gameState.roomId && !roomId) { roomId = gameState.roomId; document.getElementById('roomIdDisplay').textContent = roomId; if (!isModSession) { document.getElementById('modAccessSection').style.display = 'block'; refreshModLinks(); } } if (gameState.chatParticipantCount !== undefined) updateParticipantCount(gameState.chatParticipantCount); if (gameState.chatroomId && !pusherConnection) { document.getElementById('channelInput').value = gameState.channelName || ''; connectPusher(gameState.chatroomId); } syncToggles(); renderGame(); renderHintsPreview(); renderWinnerHistory(); break;
          case 'newGuess': gameState = data.game; if (gameState.chatParticipantCount !== undefined) updateParticipantCount(gameState.chatParticipantCount); renderGame(); renderHintsPreview(); break;
          case 'gameEnded': gameState = data.game; if (data.endReason === 'won') { document.getElementById('wordInput').value = ''; wordManuallyEdited = false; } renderGame(); renderHintsPreview(); renderWinnerHistory(); break;
          case 'hintRevealed': gameState = data.game; renderGame(); renderHintsPreview(); break;
          case 'chatStatus': var cs = document.getElementById('channelStatus'); if (data.connected) { cs.textContent = 'Connected to ' + data.channelName; cs.className = 'channel-status connected'; } else if (data.channelName) { cs.textContent = 'Not relaying â€” open admin panel to connect'; cs.className = 'channel-status'; } if (data.channelName) document.getElementById('channelInput').value = data.channelName; break;
        }
      };
    }

    function toggleCollapsible(id) {
      var el = document.getElementById(id);
      var header = el.querySelector('.collapsible-header');
      var body = el.querySelector('.collapsible-body');
      header.classList.toggle('open');
      body.classList.toggle('open');
    }

    function syncToggles() {
      if (!gameState) return;
      if (gameState.autoRestart !== undefined) document.getElementById('autoRestartToggle').checked = gameState.autoRestart;
      if (gameState.autoRestartSeconds !== undefined) document.getElementById('autoRestartSecondsInput').value = gameState.autoRestartSeconds;
      if (gameState.expandedWordPool !== undefined) { document.getElementById('expandedPoolToggle').checked = gameState.expandedWordPool; document.getElementById('expandedPoolWarning').style.display = gameState.expandedWordPool ? 'block' : 'none'; if (gameState.allowedGuessesCount) document.getElementById('expandedPoolCount').textContent = gameState.allowedGuessesCount.toLocaleString(); }
      if (gameState.shuffleWordLength !== undefined) document.getElementById('shuffleLengthToggle').checked = gameState.shuffleWordLength;
      if (gameState.hideLetterCount !== undefined) document.getElementById('hideLetterCountToggle').checked = gameState.hideLetterCount;
      if (gameState.prizeAmount) { document.getElementById('prizeToggle').checked = true; document.getElementById('prizeInputGroup').style.display = 'block'; document.getElementById('prizeInput').value = gameState.prizeAmount; } else { document.getElementById('prizeToggle').checked = false; document.getElementById('prizeInputGroup').style.display = 'none'; }
    }

    document.querySelectorAll('.mode-tab').forEach(function(tab) { tab.addEventListener('click', function() { document.querySelectorAll('.mode-tab').forEach(function(t) { t.classList.remove('active'); }); tab.classList.add('active'); currentMode = tab.dataset.mode; document.getElementById('wordleSettingsCollapsible').style.display = currentMode === 'wordle' ? 'block' : 'none'; document.getElementById('hintsCollapsible').style.display = currentMode === 'noHints' ? 'block' : 'none'; document.getElementById('aiWarning').style.display = (currentMode === 'wordle' || currentMode === 'fun') ? 'block' : 'none'; document.getElementById('funModeInfo').style.display = currentMode === 'fun' ? 'block' : 'none'; document.getElementById('wordLengthRow').style.display = currentMode === 'fun' ? 'none' : 'flex'; }); });

    async function generateRandomWord() { try { var res = await adminFetch('/api/words/random?length=' + document.getElementById('wordLength').value); var data = await res.json(); if (data.word) { document.getElementById('wordInput').value = data.word; wordManuallyEdited = true; } } catch (e) {} }
    async function startGame() {
      var word = document.getElementById('wordInput').value.trim();
      var settings = {};
      if (currentMode === 'wordle') {
        settings = { cooldownEnabled: document.getElementById('cooldownEnabled').checked, cooldownSeconds: parseInt(document.getElementById('cooldownSeconds').value)||5, maxGuessesPerUser: parseInt(document.getElementById('maxGuesses').value)||0, timerEnabled: document.getElementById('timerEnabled').checked, timerMinutes: parseInt(document.getElementById('timerMinutes').value)||10 };
      } else if (currentMode === 'noHints') {
        var mins = [3,6,9,12];
        for (var hi = 0; hi < 4; hi++) { var el = document.getElementById('hintMin' + hi); if (el) mins[hi] = parseInt(el.value) || mins[hi]; }
        settings = { hintsEnabled: document.getElementById('hintsEnabled').checked, hintMinutes: mins };
      }
      var body = { mode: currentMode, settings: settings };
      if (currentMode !== 'fun' && word && wordManuallyEdited) { body.word = word; } else { body.autoWord = true; }
      try { var res = await adminFetch('/api/game/start', { method: 'POST', body: JSON.stringify(body) }); var data = await res.json(); if (!data.success) alert('Error: ' + (data.error || 'Failed')); else { document.getElementById('wordInput').value = ''; wordManuallyEdited = false; } } catch (e) { alert('Error: ' + e.message); }
    }
    async function stopGame() { try { await adminFetch('/api/game/stop', { method: 'POST', body: '{}' }); } catch (e) {} }
    async function revealWord() { if (!confirm('Reveal the word to everyone?')) return; try { await adminFetch('/api/game/reveal', { method: 'POST', body: '{}' }); } catch (e) {} }
    async function toggleAutoRestart() { try { await adminFetch('/api/game/auto-restart', { method: 'POST', body: JSON.stringify({ enabled: document.getElementById('autoRestartToggle').checked, seconds: parseInt(document.getElementById('autoRestartSecondsInput').value) || 60 }) }); } catch (e) {} }
    async function updateAutoRestartSeconds() { try { await adminFetch('/api/game/auto-restart', { method: 'POST', body: JSON.stringify({ enabled: document.getElementById('autoRestartToggle').checked, seconds: parseInt(document.getElementById('autoRestartSecondsInput').value) || 60 }) }); } catch (e) {} }
    async function toggleShuffleLength() { try { await adminFetch('/api/game/shuffle-length', { method: 'POST', body: JSON.stringify({ enabled: document.getElementById('shuffleLengthToggle').checked }) }); } catch (e) {} }
    async function toggleExpandedPool() { var enabled = document.getElementById('expandedPoolToggle').checked; document.getElementById('expandedPoolWarning').style.display = enabled ? 'block' : 'none'; try { var res = await adminFetch('/api/game/expanded-pool', { method: 'POST', body: JSON.stringify({ enabled: enabled }) }); var data = await res.json(); if (data.wordCount) document.getElementById('expandedPoolCount').textContent = data.wordCount.toLocaleString(); } catch (e) {} }
    async function toggleHideLetterCount() { try { await adminFetch('/api/game/hide-letter-count', { method: 'POST', body: JSON.stringify({ enabled: document.getElementById('hideLetterCountToggle').checked }) }); } catch (e) {} }
    function togglePrize() { var on = document.getElementById('prizeToggle').checked; document.getElementById('prizeInputGroup').style.display = on ? 'block' : 'none'; if (!on) { document.getElementById('prizeInput').value = ''; updatePrize(); } }
    async function updatePrize() { var amount = document.getElementById('prizeToggle').checked ? document.getElementById('prizeInput').value.trim() : ''; try { await adminFetch('/api/game/prize', { method: 'POST', body: JSON.stringify({ amount: amount }) }); } catch (e) {} }
    async function resetLeaderboard() { if (!confirm('Reset the entire leaderboard? Cannot be undone.')) return; try { await adminFetch('/api/leaderboard/reset', { method: 'POST', body: '{}' }); } catch (e) {} }
    async function regenerateToken() { if (!confirm('Regenerate admin token? Old sessions will be disconnected.')) return; try { var res = await adminFetch('/api/admin/regenerate-token', { method: 'POST', body: '{}' }); var data = await res.json(); if (data.newToken) { adminToken = data.newToken; localStorage.setItem('chatgame_admin_token', data.newToken); window.location.href = '/admin'; } } catch (e) { alert('Error: ' + e.message); } }
    async function saveHint(i) { var inp = document.getElementById('hintInput' + i); if (!inp) return; try { await adminFetch('/api/game/update-hint', { method: 'POST', body: JSON.stringify({ hintIndex: i, newText: inp.value }) }); } catch (e) {} editingHints[i] = false; renderHintsPreview(); }
    async function revealHint(i) { try { await adminFetch('/api/game/reveal-hint', { method: 'POST', body: JSON.stringify({ hintIndex: i }) }); } catch (e) {} }
    function openViewer() { if (roomId) window.open('/?room=' + roomId, '_blank', 'width=1200,height=900'); else alert('Room not ready yet'); }
    function copyViewerLink() { if (!roomId) { alert('Room not ready yet'); return; } var url = window.location.origin + '/?room=' + roomId; navigator.clipboard.writeText(url).then(function() { var btns = document.querySelectorAll('.button-primary'); btns.forEach(function(b) { if (b.textContent.match(/copy/i)) { b.textContent = 'Copied!'; setTimeout(function() { b.textContent = 'Copy Viewer Link'; }, 2000); } }); }).catch(function() { prompt('Copy this viewer link:', url); }); }
    async function downloadParticipants() { if (!adminToken) return; try { var res = await adminFetch('/api/participants/csv'); var blob = await res.blob(); var url = URL.createObjectURL(blob); var a = document.createElement('a'); a.href = url; a.download = 'participants.csv'; a.click(); URL.revokeObjectURL(url); } catch(e) {} }
    async function clearParticipants() { if (!confirm('Clear the participants list?')) return; try { await adminFetch('/api/participants/clear', { method: 'POST', body: '{}' }); updateParticipantCount(0); } catch(e){} }
    function updateParticipantCount(count) { var el = document.getElementById('participantCount'); if (el) el.textContent = count > 0 ? count + ' chatters tracked' : 'No chatters yet'; }

    // MOD PERMISSIONS
    function applyModPermissions() {
      if (!isModSession || !modPerms) return;
      // Show mod banner
      document.getElementById('modBanner').style.display = 'block';
      // Hide owner-only sections
      document.getElementById('modAccessSection').style.display = 'none';
      // Title change
      document.querySelector('.header h1').textContent = 'Chat Guessing Game - Mod Panel';
      // Permission-based visibility
      if (!modPerms.gameControls) { document.getElementById('startBtnWrap').classList.add('perm-denied'); document.getElementById('stopRevealWrap').classList.add('perm-denied'); }
      if (!modPerms.connectChat) document.getElementById('channelWrap').classList.add('perm-denied');
      if (!modPerms.changeMode) document.getElementById('modeTabsWrap').classList.add('perm-denied');
      if (!modPerms.setWord) document.getElementById('wordSettingsWrap').classList.add('perm-denied');
      if (!modPerms.changeSettings) document.getElementById('settingsWrap').classList.add('perm-denied');
      if (!modPerms.changeSettings && !modPerms.changeMode) document.getElementById('wordleSettingsWrap').classList.add('perm-denied');
      if (!modPerms.editHints) document.getElementById('hintsPreviewWrap').classList.add('perm-denied');
      if (!modPerms.dangerZone) document.getElementById('dangerZoneWrap').classList.add('perm-denied');
      // Update mod expiry display
      updateModExpiry();
    }
    function updateModExpiry() {
      if (!isModSession) return;
      // Parse expiry from the token info we can infer (server sends funTimeLeft-like data)
      // Actually we get it from reconnect, but simplest: just show "3 hours from session start"
      var el = document.getElementById('modExpiryText');
      if (!el) return;
      function tick() {
        // We can't know exact expiry client-side without the server telling us
        // The server will kick us when expired, so just show a message
        el.textContent = 'This link expires after 3 hours. You will be disconnected when it expires.';
      }
      tick();
    }

    // MOD PRESET TABS
    var modPresets = {
      operator: { gameControls: true, connectChat: false, changeMode: false, setWord: false, changeSettings: false, editHints: false, dangerZone: false },
      fullmod: { gameControls: true, connectChat: true, changeMode: true, setWord: true, changeSettings: true, editHints: true, dangerZone: false },
      custom: null
    };
    document.querySelectorAll('.mod-preset-tab').forEach(function(tab) {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.mod-preset-tab').forEach(function(t) { t.classList.remove('active'); });
        tab.classList.add('active');
        var preset = tab.dataset.preset;
        var perms = modPresets[preset];
        var checkboxes = document.getElementById('modPermList');
        if (preset === 'custom') {
          checkboxes.style.opacity = '1'; checkboxes.style.pointerEvents = 'auto';
        } else {
          checkboxes.style.opacity = '0.6'; checkboxes.style.pointerEvents = 'none';
          if (perms) {
            Object.keys(perms).forEach(function(key) {
              var cb = document.getElementById('modPerm_' + key);
              if (cb) cb.checked = perms[key];
            });
          }
        }
      });
    });
    // Init to operator preset
    (function() { var p = modPresets.operator; Object.keys(p).forEach(function(k) { var cb = document.getElementById('modPerm_' + k); if (cb) cb.checked = p[k]; }); document.getElementById('modPermList').style.opacity = '0.6'; document.getElementById('modPermList').style.pointerEvents = 'none'; })();

    // MOD LINK MANAGEMENT
    async function createModLink() {
      var perms = {};
      ['gameControls','connectChat','changeMode','setWord','changeSettings','editHints','dangerZone'].forEach(function(k) {
        var cb = document.getElementById('modPerm_' + k);
        perms[k] = cb ? cb.checked : false;
      });
      var activePreset = document.querySelector('.mod-preset-tab.active');
      var label = activePreset ? activePreset.textContent.trim() : 'Custom';
      try {
        var res = await adminFetch('/api/admin/create-mod-link', { method: 'POST', body: JSON.stringify({ label: label, permissions: perms }) });
        var data = await res.json();
        if (data.error) { alert('Error: ' + data.error); return; }
        if (data.modToken) {
          var modUrl = window.location.origin + '/admin?token=' + data.modToken;
          try { await navigator.clipboard.writeText(modUrl); alert('Mod link copied to clipboard! It expires in 3 hours.\n\nâš  Share this ONLY in private DMs!'); } catch(e) { prompt('Copy this mod link (expires in 3 hours).\nâš  Share ONLY in private DMs!', modUrl); }
        }
        refreshModLinks();
      } catch(e) { alert('Error: ' + e.message); }
    }
    async function revokeModLink(token) {
      if (!confirm('Revoke this mod link? The mod will be disconnected immediately.')) return;
      try { await adminFetch('/api/admin/revoke-mod-link', { method: 'POST', body: JSON.stringify({ modToken: token }) }); refreshModLinks(); } catch(e) {}
    }
    async function copyModLink(token) {
      var url = window.location.origin + '/admin?token=' + token;
      try { await navigator.clipboard.writeText(url); alert('Mod link copied!\n\nâš  Share ONLY in private DMs!'); } catch(e) { prompt('Copy this mod link.\nâš  Share ONLY in private DMs!', url); }
    }
    async function refreshModLinks() {
      try {
        var res = await adminFetch('/api/admin/mod-links');
        var data = await res.json();
        var el = document.getElementById('modLinksList');
        if (!data.modLinks || data.modLinks.length === 0) { el.innerHTML = '<div style="color:#666;font-size:0.85em;text-align:center;padding:8px">No active mod links</div>'; return; }
        var h = '';
        data.modLinks.forEach(function(m) {
          var timeLeft = Math.max(0, Math.floor((m.expires - Date.now()) / 60000));
          var permList = Object.keys(m.permissions).filter(function(k) { return m.permissions[k]; }).join(', ');
          h += '<div class="mod-link-item">';
          h += '<div class="mod-link-info"><div class="mod-link-label">' + m.label + '</div><div class="mod-link-expiry">Expires in ' + timeLeft + ' min</div><div class="mod-link-perms">' + permList + '</div></div>';
          h += '<div style="display:flex;gap:4px"><button class="button button-secondary button-sm" onclick="copyModLink(\'' + m.token + '\')">Copy</button><button class="button button-danger button-sm" onclick="revokeModLink(\'' + m.token + '\')">Revoke</button></div>';
          h += '</div>';
        });
        el.innerHTML = h;
      } catch(e) {}
    }

    function renderHintsPreview() {
      var c = document.getElementById('hintsPreview');
      if (!gameState || gameState.mode !== 'noHints') {
        // No active hard mode game â€” show default minute config
        var defaults = (gameState && gameState.hintMinutes) ? gameState.hintMinutes : [3,6,9,12];
        var h = '<div class="hints-panel">';
        for (var i = 0; i < 4; i++) {
          h += '<div class="hint-row"><span class="hint-num">' + (i+1) + '</span>';
          h += '<span class="hint-time"><input type="number" id="hintMin' + i + '" value="' + (defaults[i]||[3,6,9,12][i]) + '" min="1" max="60" style="width:40px;padding:2px 4px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:4px;color:#fff;text-align:center;font-size:0.9em"> min</span>';
          h += '<span class="hint-text" style="color:#666;font-style:italic">Auto-generated when game starts</span>';
          h += '<span></span></div>';
        }
        h += '</div>';
        c.innerHTML = h;
        return;
      }
      if (!gameState.allHints || gameState.allHints.length === 0) { c.innerHTML = ''; return; }
      var mins = gameState.hintMinutes || [3,6,9,12], rev = gameState.hintsRevealedIndices || [];
      var h = '<div class="hints-panel">';
      gameState.allHints.forEach(function(hint, i) {
        var isRev = rev.indexOf(i) !== -1, isEdit = editingHints[i] === true;
        var text = (hint && hint.text) ? hint.text : '';
        h += '<div class="hint-row ' + (isRev ? 'revealed' : '') + '"><span class="hint-num">' + (i+1) + '</span>';
        h += '<span class="hint-time"><input type="number" id="hintMin' + i + '" value="' + (mins[i]||'?') + '" min="1" max="60" style="width:40px;padding:2px 4px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:4px;color:#fff;text-align:center;font-size:0.9em"> min</span>';
        if (isEdit) h += '<span class="hint-text"><input id="hintInput' + i + '" value="' + text.replace(/"/g,'&quot;') + '"></span><span><button class="hint-btn hint-btn-save" onclick="saveHint(' + i + ')">Save</button></span>';
        else { h += '<span class="hint-text">' + text + (isRev ? ' [SENT]' : '') + '</span><span>'; if (!isRev) h += '<button class="hint-btn hint-btn-edit" onclick="editingHints[' + i + ']=true;renderHintsPreview();">Edit</button> <button class="hint-btn hint-btn-reveal" onclick="revealHint(' + i + ')">Send</button>'; h += '</span>'; }
        h += '</div>';
      }); h += '</div>'; c.innerHTML = h;
    }
    function renderWinnerHistory() { var c = document.getElementById('winnerHistory'), l = document.getElementById('winnerHistoryList'); if (!gameState || !gameState.winnerHistory || !gameState.winnerHistory.length) { c.style.display = 'none'; return; } c.style.display = 'block'; l.innerHTML = gameState.winnerHistory.map(function(w) { var t = new Date(w.timestamp).toLocaleTimeString(); return '<div class="wh-item"><span class="wh-user">' + w.username + '</span><span class="wh-word">' + w.word + '</span><span class="wh-info">' + w.totalGuesses + ' guesses | ' + t + '</span></div>'; }).join(''); }
    function renderAdminWord() { if (!gameState) return ''; var best = gameState.bestLetterStatus || {}; return Array(gameState.wordLength).fill(0).map(function(_, i) { var info = best[i]; if (info) return '<div class="letter-box ' + info.status + '">' + info.letter.toUpperCase() + '</div>'; return '<div class="letter-box">?</div>'; }).join(''); }
    function getAdminTimer() { if (!gameState || !gameState.startTime) return '-'; var end = gameState.endTime || Date.now(); return Math.floor((end - gameState.startTime) / 1000) + 's'; }
    function renderGame() {
      var content = document.getElementById('gameContent'), dot = document.getElementById('statusDot');
      if (!gameState || (!gameState.active && !gameState.winner && !gameState.revealedWord && !gameState.stopped)) { dot.classList.remove('active'); content.innerHTML = '<div class="no-game"><h3>No Active Game</h3><p>Start a game to begin</p></div>'; return; }
      dot.classList.toggle('active', !!gameState.active);
      var h = '';
      if (gameState.winner) h += '<div class="winner-banner">' + gameState.winner + ' guessed the word!</div>';
      if (gameState.stopped && !gameState.winner) h += '<div class="stopped-banner">Game Stopped</div>';
      var aw = gameState.actualWord || '';
      h += '<div class="word-display"><h3>' + (gameState.mode === 'fun' ? 'Fun Mode' : (gameState.mode === 'wordle' ? 'Wordle Mode' : 'Hard Mode')) + '</h3><div class="letters" id="adminWordLetters">' + renderAdminWord() + '</div>';
      if (aw) h += '<div class="actual-word">Answer: ' + aw.toUpperCase() + '</div>';
      h += '</div>';
      h += '<div class="game-stats"><div class="stat-card"><div class="value" id="adminGuesses">' + (gameState.stats ? gameState.stats.totalGuesses : 0) + '</div><div class="label">Guesses</div></div><div class="stat-card"><div class="value" id="adminPlayers">' + (gameState.stats ? gameState.stats.uniquePlayers : 0) + '</div><div class="label">Players</div></div><div class="stat-card"><div class="value" id="adminTimer">' + getAdminTimer() + '</div><div class="label">Time</div></div></div>';
      h += '<h3 style="color:#00ff88;margin-bottom:12px">Live Guesses</h3><div class="guesses-feed" id="guessesFeed">';
      if (gameState.guesses && gameState.guesses.length > 0) { gameState.guesses.slice().reverse().forEach(function(g) { h += renderGuess(g); }); }
      else h += '<div style="text-align:center;color:#666;padding:30px">No guesses yet...</div>';
      h += '</div>'; content.innerHTML = h;
    }
    function renderGuess(g) { var t = new Date(g.timestamp).toLocaleTimeString(); var wrongLen = g.result && g.result.wrongLength; var l = ''; if (g.result && g.result.letters && g.result.letters.length > 0) l = g.result.letters.map(function(x) { return '<div class="letter ' + (x.status||'') + '">' + x.letter.toUpperCase() + '</div>'; }).join(''); else if (g.guess) l = g.guess.split('').map(function(x) { return '<div class="letter">' + x.toUpperCase() + '</div>'; }).join(''); return '<div class="guess-item ' + (g.isWinner ? 'winner' : '') + (wrongLen ? ' wrong-length' : '') + '"><div class="username">' + g.username + '</div><div class="guess-word">' + l + '</div><div class="timestamp">' + t + '</div></div>'; }
    setInterval(function() { if (gameState && gameState.active && gameState.startTime && !gameState.endTime) { var el = document.getElementById('adminTimer'); if (el) el.textContent = Math.floor((Date.now() - gameState.startTime) / 1000) + 's'; } }, 1000);
  </script>
</body>
</html>
